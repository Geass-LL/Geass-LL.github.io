---
layout: post
date: 2020-01-01 16:00:00 +0800
title: "Some drafts"
category: draft
---

## systemd

#### Q：systemd的一些基础的服务是怎么拉起的？例如`systemd-tmpfiles-setup.service`。

A：通过`/lib/systemd/system/sysinit.target.wants/`目录创建的依赖关系。

## criu

criu能够用于进程的保存和恢复，基于的信息全部来自于内核接口，原声的criu没有内核态代码。

主函数的入口是`criu/crtools.c`，保存的主入口：`cr_dump_tasks`，恢复的主入口：`cr_restore_tasks`。

在保存进程状态前，criu会使用freezer cgroup或者ptrace冻结进程，避免状态不一致。保存一个进程涉及的关键信息很多，例如：信号、内存布局、cgroup等。

**内存恢复：** 调用`prctl(2)`的PR_SET_MM。
**PID的恢复：** 调用`clone(3)`配置PID。这里是如何确保PID不被复用的？
